<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Firefox Refined Findbar – SCSS helper</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 2rem; }
    textarea { width: 100%; min-height: 320px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size: 13px; }
    code,kbd { background: #f6f8fa; padding: 0.1rem 0.25rem; border-radius: 4px; }
    .row { display: flex; gap: 1rem; flex-wrap: wrap; }
    .row > * { flex: 1 1 320px; }
    button { padding: .5rem .75rem; cursor: pointer; }
    .hint { color: #666; font-size: 0.95em; }
  </style>
</head>
<body>
  <h1>Firefox Refined Findbar – SCSS helper</h1>
  <p>
    1) Click “Copy SCSS” → 2) Open <a href="https://sass-lang.com/playground/" target="_blank" rel="noreferrer">Sass Playground</a> → 3) Paste into SCSS pane → 4) Tweak options and copy generated CSS into <code>chrome/findbar.css</code>.
  </p>

  <div class="row">
    <div>
      <h3>SCSS template</h3>
      <p class="hint">The <code>@include</code> block is where you tweak.</p>
      <textarea id="scss"></textarea>
      <p>
        <button id="copy">Copy SCSS</button>
        <button id="generateLink">Generate Playground Link</button>
        <a href="https://sass-lang.com/playground/" target="_blank" rel="noreferrer">
          <button>Open Sass Playground</button>
        </a>
      </p>
    </div>
    <div>
      <h3>Notes</h3>
      <ul>
        <li>Default options: fixed, centered, top, 150% scale, side margin = float distance.</li>
        <li>Save resulting CSS to <code>chrome/findbar.css</code>. Firefox loads <code>chrome/userChrome.css</code> which imports it.</li>
        <li>Restart Firefox to apply changes.</li>
      </ul>
      <p class="hint">Attribution: Based on and inspired by
        <a href="https://github.com/ravindUwU/firefox-refined-findbar" target="_blank" rel="noreferrer">ravindUwU/firefox-refined-findbar</a>.
      </p>
    </div>
  </div>

  <script>
    const scss = `/* SCSS entry that includes the refined findbar mixin with defaults you can change.
   The compiled CSS is written to chrome/findbar.css by the build workflow or \`npm run build\`.
*/

@use 'sass:list';
@use 'sass:math';
@use 'sass:map';

/* Refined findbar for Firefox
   Extended with fixed/centered placement, scaling, and side margins.
   Attribution: Based on and inspired by https://github.com/ravindUwU/firefox-refined-findbar
*/

@mixin /* sig:start */
  refined-findbar(
    $float: true,
    $float-alignment: bottom,
    $float-distance: 18px,

    $buttons: true,
    $buttons-grouped: true,

    $hide-close-button: false,
    $hide-when-unfocused: false,
    $opacity-when-unfocused: 1,

    $order: (
      TEXT_BOX,
      CHECKBOX_HIGHLIGHT_ALL,
      CHECKBOX_MATCH_CASE,
      CHECKBOX_MATCH_DIACRITICS,
      CHECKBOX_WHOLE_WORDS,
      LABELS,
      DESCRIPTION,
    ),

    /* NEW: positioning and layout */
    $fixed: false,
    $centered: false,

    /* NEW: scaling */
    $scale: 1,

    /* NEW: symmetric left/right margin (defaults to $float-distance) */
    $side-margin: null
  )
  /* sig:end */ {
  @namespace url('http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul');
  @namespace htmlNs url('http://www.w3.org/1999/xhtml');

  /* Derived sizing based on scale */
  $space: $-space * $scale;
  $pad-all: 6px * $scale;
  $border-w: 1px * $scale;
  $check-pad-y: 3px * $scale;
  $check-pad-x: 6px * $scale;

  /* Resolve side margin default */
  $lr-margin: if($side-margin == null, $float-distance, $side-margin);

  // MARK: Position

  findbar {
    contain: content;

    /* Scale text and inherited sizes */
    @if ($scale != 1) {
      font-size: #{math.percentage($scale)};
    }

    /* The findbar sits in a relatively positioned vbox.browserContainer.
       We absolutely position within it by default; optionally switch to fixed. */
    position: if($fixed, fixed, absolute);

    @if $float {
      /* Vertical offset */
      #{$float-alignment}: $float-distance;

      @if $centered {
        /* center horizontally with equal margins from both sides */
        left: $lr-margin;
        right: $lr-margin;
        margin-inline: auto;
        width: max-content;
        @if $fixed {
          max-width: calc(100vw - #{2 * $lr-margin});
        } @else {
          max-width: calc(100% - #{2 * $lr-margin});
        }
        z-index: 9999;
      } @else {
        right: $float-distance;
      }
    } @else {
      /* Docked mode: merge into top chrome by -1px */
      top: -1px;
      right: 44px;
    }
  }

  // MARK: Children

  findbar {
    gap: $space;
    padding: $pad-all;
    padding-inline-start: $space;
    padding-inline-end: $space;

    & > * {
      margin-inline-start: 0 !important;
      margin-inline-end: 0 !important;
    }

    .findbar-container {
      gap: $space;

      & > * {
        margin-inline-start: 0 !important;
        margin-inline-end: 0 !important;
      }
    }

    description.findbar-label:empty {
      display: none;
    }

    @if ($hide-close-button) {
      toolbarbutton.findbar-closebutton {
        display: none;
      }
    }
  }

  // MARK: Border

  findbar {
    border: #{$border-w} solid var(--chrome-content-separator-color);

    @if $float {
      border-radius: var(--toolbarbutton-border-radius);
    } @else {
      border-bottom-left-radius: var(--toolbarbutton-border-radius);
      border-bottom-right-radius: var(--toolbarbutton-border-radius);
      border-top-width: 0 !important;
    }
  }

  // MARK: Animation

  @keyframes refined-findbar-scale-in {
    0% { transform: scaleY(0); }
    100% { transform: scaleY(1); }
  }

  @keyframes refined-findbar-scale-out {
    0% { transform: scaleY(1); visibility: visible; }
    99% { transform: scaleY(0); visibility: visible; }
    100% { transform: scaleY(0); }
  }

  findbar {
    transform-origin: if($float, $float-alignment, top) center;
    animation: refined-findbar-scale-in 0.1s;

    &[hidden='true'] {
      animation: refined-findbar-scale-out 0.1s;
    }
  }

  // MARK: Hide when unfocused

  @if ($hide-when-unfocused) {
    @keyframes refined-findbar-hide-when-unfocused {
      0% { opacity: 1; height: auto; }
      99% { opacity: 1; height: auto; }
      100% {}
    }

    findbar:not(:focus-within) {
      animation:
        refined-findbar-scale-out 0.1s,
        refined-findbar-hide-when-unfocused 0.1s;
      height: 0;
      opacity: 0;
      pointer-events: none;
      overflow: hidden;
    }
  }

  // MARK: Opacity when unfocused

  @if ($opacity-when-unfocused < 1) {
    findbar {
      transition: opacity 0.1s;
      opacity: 1;

      &:not(:focus-within) {
        opacity: $opacity-when-unfocused;
      }
    }
  }

  // MARK: Text box

  findbar [anonid='findbar-textbox-wrapper'] {
    htmlNs|input {
      border: #{$border-w} solid ThreeDShadow;

      @if $buttons and $buttons-grouped {
        &:not(.minimal) {
          border-top-right-radius: 0 !important;
          border-bottom-right-radius: 0 !important;
        }
      }
    }

    /* Prev & next buttons (hidden in quick find mode) */
    toolbarbutton {
      color: var(--button-color);
      background-color: #{-var(button-background-color, button-bgcolor)};
      border: #{$border-w} solid ThreeDShadow;
      margin-inline: 0 !important;

      @if $buttons and $buttons-grouped {
        &:last-of-type {
          border-top-left-radius: 0 !important;
          border-bottom-left-radius: 0 !important;
        }
        &:not(:last-of-type) {
          border-radius: 0 !important;
          border-right-width: 0 !important;
        }
      }
    }
  }

  // MARK: Checkboxes

  $checkbox-by-index: ();
  @each $name in map.keys($-checkbox-selectors) {
    $checkbox-by-index: map.set($checkbox-by-index, list.index($order, $name), $name);
  }
  $first-checkbox: map.get($checkbox-by-index, math.min(map.keys($checkbox-by-index)...));
  $last-checkbox: map.get($checkbox-by-index, math.max(map.keys($checkbox-by-index)...));

  findbar checkbox {
    @if $buttons {
      padding: $check-pad-y $check-pad-x;
      border: #{$border-w} solid ThreeDShadow;
      border-radius: var(--toolbarbutton-border-radius);
      color: var(--button-color);
      background-color: #{-var(button-background-color, button-bgcolor)};

      &:hover {
        background-color: #{-var(button-background-color-hover, button-hover-bgcolor)};
      }
      &:active {
        background-color: #{-var(button-background-color-active, button-active-bgcolor)};
      }

      &[checked='true'] {
        color: #{-var(button-text-color-primary, button-primary-color)};
        background-color: #{-var(color-accent-primary, button-primary-bgcolor)};

        &:hover {
          background-color: #{-var(color-accent-primary-hover, button-primary-hover-bgcolor)};
        }
        &:active {
          background-color: #{-var(color-accent-primary-active, button-primary-active-bgcolor)};
        }
      }

      &:focus-visible {
        outline: var(--focus-outline);
        outline-offset: var(--focus-outline-inset);
      }

      .checkbox-check { display: none; }

      @if $buttons-grouped {
        &:not(#{map.get($-checkbox-selectors, $last-checkbox)}) {
          border-top-right-radius: 0;
          border-bottom-right-radius: 0;
        }
        &:not(#{map.get($-checkbox-selectors, $first-checkbox)}) {
          border-top-left-radius: 0;
          border-bottom-left-radius: 0;
          border-left-width: 0;
          margin-inline-start: -$space !important;
        }
      } @else {
        &:not(#{map.get($-checkbox-selectors, $first-checkbox)}) {
          margin-inline-start: -1 * math.div($space, 2) !important;
        }
      }
    } @else {
      &:is(#{map.get($-checkbox-selectors, $first-checkbox)}) {
        margin-inline-start: math.div($space, 2) !important;
      }
      &:is(#{map.get($-checkbox-selectors, $last-checkbox)}) {
        margin-inline-end: math.div($space, 2) !important;
      }
    }
  }

  // MARK: Order

  findbar {
    [anonid='findbar-textbox-wrapper'] {
      order: list.index($order, TEXT_BOX) - 1;
    }

    @each $name, $selector in $-checkbox-selectors {
      #{$selector} {
        order: list.index($order, $name) - 1;
      }
    }

    label.findbar-label {
      order: list.index($order, LABELS) - 1;
    }

    description.findbar-label {
      order: list.index($order, DESCRIPTION) - 1;
    }
  }
}

$-space: 8px;

/* Checkbox selectors mapping */
$-checkbox-selectors: (
  CHECKBOX_HIGHLIGHT_ALL: "checkbox[anonid='highlight']",
  CHECKBOX_MATCH_CASE: "checkbox[anonid='find-case-sensitive']",
  CHECKBOX_MATCH_DIACRITICS: "checkbox[anonid='find-match-diacritics']",
  CHECKBOX_WHOLE_WORDS: "checkbox[anonid='find-entire-word']",
);

/* var() helper with fallbacks */
@function -var($names...) {
  $css: '';
  @for $i from list.length($names) through 1 {
    @if $css == '' {
      $css: 'var(--' + list.nth($names, $i) + ')';
    } @else {
      $css: 'var(--' + list.nth($names, $i) + ', ' + $css + ')';
    }
  }
  @return $css;
}

// prettier-ignore
@include refined-findbar(
  $float: true,
  $float-alignment: top,
  $float-distance: 18px,

  $buttons: true,
  $buttons-grouped: true,

  $hide-close-button: false,
  $hide-when-unfocused: false,
  $opacity-when-unfocused: 1,

  $order: (
    TEXT_BOX,
    CHECKBOX_HIGHLIGHT_ALL,
    CHECKBOX_MATCH_CASE,
    CHECKBOX_MATCH_DIACRITICS,
    CHECKBOX_WHOLE_WORDS,
    LABELS,
    DESCRIPTION,
  ),

  // Extended options
  $fixed: true,
  $centered: true,
  $scale: 1.5,
  $side-margin: null
);
`;
    document.getElementById('scss').value = scss;
    
    // Copy SCSS to clipboard
    document.getElementById('copy').addEventListener('click', async () => {
      const el = document.getElementById('scss');
      el.select();
      el.setSelectionRange(0, el.value.length);
      try { await navigator.clipboard.writeText(el.value); } catch {}
    });
    
    // Generate Playground Link
    document.getElementById('generateLink').addEventListener('click', async () => {
      const scssContent = document.getElementById('scss').value;
      
      try {
        // Implement compression similar to the reference implementation
        async function deflateToBase64(input) {
          const encoder = new TextEncoder();
          const data = encoder.encode(input);
          
          // Use CompressionStream if available (modern browsers)
          if ('CompressionStream' in window) {
            const compressionStream = new CompressionStream('deflate');
            const writer = compressionStream.writable.getWriter();
            const reader = compressionStream.readable.getReader();
            
            writer.write(data);
            writer.close();
            
            const chunks = [];
            let done = false;
            while (!done) {
              const { value, done: readerDone } = await reader.read();
              done = readerDone;
              if (value) chunks.push(value);
            }
            
            const compressed = new Uint8Array(chunks.reduce((acc, chunk) => acc + chunk.length, 0));
            let offset = 0;
            for (const chunk of chunks) {
              compressed.set(chunk, offset);
              offset += chunk.length;
            }
            
            return btoa(String.fromCharCode(...compressed));
          } else {
            // Fallback: just use base64 without compression
            return btoa(input);
          }
        }
        
        async function serializeStateContents(inputValue) {
          // Format: inputFormat(scss=1) + outputFormat(expanded=1) + content
          const persistedState = `11${inputValue}`;
          return await deflateToBase64(persistedState);
        }
        
        const encodedContent = await serializeStateContents(scssContent);
        const playgroundUrl = `https://sass-lang.com/playground/#${encodedContent}`;
        
        // Copy URL to clipboard and provide feedback
        await navigator.clipboard.writeText(playgroundUrl);
        const originalText = document.getElementById('generateLink').textContent;
        document.getElementById('generateLink').textContent = 'URL Copied!';
        
        setTimeout(() => {
          document.getElementById('generateLink').textContent = originalText;
        }, 2000);
        
      } catch (error) {
        // Fallback: just open the playground
        window.open('https://sass-lang.com/playground/', '_blank');
        console.error('Failed to generate playground link:', error);
      }
    });
  </script>
</body>
</html>